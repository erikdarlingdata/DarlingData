name: SQL Tests

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev, main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - version: '2017'
            image: mcr.microsoft.com/mssql/server:2017-latest
            health_cmd: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'CI_Test#2026!' -Q 'SELECT 1' -b
          - version: '2019'
            image: mcr.microsoft.com/mssql/server:2019-latest
            health_cmd: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'CI_Test#2026!' -Q 'SELECT 1' -b
          - version: '2022'
            image: mcr.microsoft.com/mssql/server:2022-latest
            health_cmd: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'CI_Test#2026!' -C -No -Q 'SELECT 1' -b
          - version: '2025'
            image: mcr.microsoft.com/mssql/server:2025-latest
            health_cmd: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'CI_Test#2026!' -C -No -Q 'SELECT 1' -b

    name: SQL Server ${{ matrix.version }}

    services:
      sqlserver:
        image: ${{ matrix.image }}
        env:
          ACCEPT_EULA: Y
          MSSQL_SA_PASSWORD: CI_Test#2026!
        ports:
          - 1433:1433
        options: >-
          --health-cmd "${{ matrix.health_cmd }}"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Install sqlcmd
        run: |
          curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc > /dev/null
          source /etc/os-release
          echo "deb [arch=amd64] https://packages.microsoft.com/ubuntu/${VERSION_ID}/prod ${VERSION_CODENAME} main" | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18

      - name: Create test database
        env:
          SA_PASSWORD: CI_Test#2026!
        run: |
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -Q "CREATE DATABASE DarlingData_CI_Test;"
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -d DarlingData_CI_Test -Q "ALTER DATABASE DarlingData_CI_Test SET QUERY_STORE = ON;"

      - name: Regenerate DarlingData.sql from current branch
        shell: pwsh
        run: |
          Push-Location Install-All
          ./Merge-All.ps1
          Pop-Location

      - name: Install all procedures
        env:
          SA_PASSWORD: CI_Test#2026!
        run: |
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -d DarlingData_CI_Test -i "Install-All/DarlingData.sql"

      - name: Verify procedures exist
        env:
          SA_PASSWORD: CI_Test#2026!
        run: |
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -d DarlingData_CI_Test -Q "
            SET NOCOUNT ON;
            DECLARE @missing int = 0;
            IF OBJECT_ID(N'dbo.sp_HealthParser', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_HealthParser'; END;
            IF OBJECT_ID(N'dbo.sp_HumanEvents', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_HumanEvents'; END;
            IF OBJECT_ID(N'dbo.sp_HumanEventsBlockViewer', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_HumanEventsBlockViewer'; END;
            IF OBJECT_ID(N'dbo.sp_IndexCleanup', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_IndexCleanup'; END;
            IF OBJECT_ID(N'dbo.sp_LogHunter', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_LogHunter'; END;
            IF OBJECT_ID(N'dbo.sp_PerfCheck', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_PerfCheck'; END;
            IF OBJECT_ID(N'dbo.sp_PressureDetector', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_PressureDetector'; END;
            IF OBJECT_ID(N'dbo.sp_QueryReproBuilder', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_QueryReproBuilder'; END;
            IF OBJECT_ID(N'dbo.sp_QuickieStore', N'P') IS NULL BEGIN SET @missing += 1; PRINT 'MISSING: sp_QuickieStore'; END;
            IF @missing > 0
              RAISERROR('Missing %d procedure(s)', 16, 1, @missing);
            ELSE
              PRINT 'All 9 procedures installed successfully';
          "

      - name: Test help output
        env:
          SA_PASSWORD: CI_Test#2026!
        run: |
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -d DarlingData_CI_Test -i ".github/sql/test_help_output.sql"

      - name: Test basic execution
        env:
          SA_PASSWORD: CI_Test#2026!
        run: |
          /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "$SA_PASSWORD" -C -No -b -d DarlingData_CI_Test -i ".github/sql/test_basic_execution.sql"
